# 裁量トレード記録・分析ツール 開発チケット案

## #1: UIパネルの基本骨格作成 [完了]
- **内容:**
    - チャート上に操作用のUIパネルを常時表示する。
    - パネル内に、以下の静的な要素を配置する。
        - `[記録セッション開始]` ボタン
        - `[根拠エリア追加]` ボタン
        - `[トレードエリア追加]` ボタン
        - `[セッションを完了して記録]` ボタン
        - 「全体コメント」用の大型テキスト入力ボックス
        - 根拠コメントエリアのプレースホルダー
- **デバッグポイント:**
    - チャートの時間足や通貨ペアを切り替えても、UIが崩れずに表示され続けるか。
    - この時点では、ボタンを押しても何も動作しないことを確認する。

## #2: 記録セッションの状態管理 [完了]
- **内容:**
    - `[記録セッション開始]` ボタンでセッションフラグを `true` にする。
    - セッション中は `[根拠エリア追加]` と `[トレードエリア追加]` ボタンを有効化する。
    - `[セッションを完了して記録]` ボタンでセッションフラグを `false` に戻す。
- **デバッグポイント:**
    - セッションの開始・終了に応じて、ボタンの有効/無効が正しく切り替わるか。
    - 内部的な状態変数が意図通りに変化するか。

## #3: 根拠エリア（青い四角形）の描画と管理 [完了]
- **内容:**
    - `[根拠エリア追加]` ボタンを押した後、ユーザーがマウスドラッグで青い四角形を描画できるようにする。
    - 描画が完了するたびに、オブジェクトに連番 (1, 2, 3...) を付与してチャート上に表示する。
    - 描画したオブジェクトの座標、時間足、番号を内部的にリストで保持する。
- **デバッグポイント:**
    - 四角形が意図した場所に描画されるか。
    - 番号が正しく、重複せずに付与されるか。
    - 複数時間足にまたがって描画しても、情報が正しく保持されるか。 [完了]


## #4: トレードエリア（赤い四角形）の描画と管理 [完了]
- **内容:**
    - `[トレードエリア追加]` ボタンで、赤い四角形を描画できるようにする。
    - この四角形はセッション中に一つだけ描画可能とする（再度描画した場合は上書きする）。
    - 描画したオブジェクトの座標を内部的に保持する。
- **デバッグポイント:**
    - 赤い四角形が描画・上書きできるか。
    - 座標情報が正しく保持されるか。

## #4.4: githubにバックアップを作成する。

## #4.5: リファクタリングと最適化 [完了]
- **内容:**
    - 今後の追加する機能を見据えてリファクタリングを行う。
    - 効率化できるところは最適化する。
- **デバッグポイント:**
    - 完了ボタンや根拠の削除ボタンを押したときに、正しく動作するか。すべて、根拠やトレードエリアの四角やラベルが正しく削除されるか。

## #5: 動的UIとコメント入力機能 [完了]
- **内容:**
    - チケット#3で根拠エリアが追加されるたびに、UIパネルに「根拠 [番号]: [テキストボックス]」を動的に生成する。
    - 各テキストボックスに入力された内容と、全体コメントを内部変数に保存する。
- **デバッグポイント:**
    - 根拠エリアの描画とUIのコメント欄生成がリアルタイムに連動するか。
    - 入力したコメントが、対応する根拠番号や全体コメントとして正しく内部変数に格納されるか。

## #6: データ保存機能 (CSV) [完了]
- **内容:**
    - `[セッションを完了して記録]` を押した際に、内部で保持している全データを `trades.csv` と `evidence.csv` に追記保存する。
    - `TradeID` (タイムスタンプ等) を生成し、両方のCSVで関連付けを行う。
    - 保存先フォルダが存在しない場合は自動で作成する。
- **デバッグポイント:**
    - 指定のパス (`MQL4\Files\ChartMemo`) にCSVファイルが正しく生成・追記されるか。
    - データ構造（カラムの順序、内容）が要件定義書通りであるか。
    - `TradeID` によって `trades.csv` の1レコードと `evidence.csv` の複数レコードが正しく紐づいているか。


## #7: チャート画像保存機能 [完了]
- **内容:**
    - CSV保存と同時に、現在のチャートのスクリーンショットをPNG形式で保存する。
    - ファイル名は要件定義の通り `(通貨ペア)_(時間足)_(TradeID).png` とする。
- **デバッグポイント:**
    - 描画した全てのオブジェクト（四角形、番号）が含まれた状態で画像が保存されているか。
    - ファイル名が正しく生成されているか。

## #8: セッション完了時のクリーンアップ処理 [完了]
- **内容:**
    - 全てのデータ・画像の保存が完了した後、セッション中に描画した全てのオブジェクト（四角形、番号）をチャート上から削除する。
    - UI上の全てのコメント入力欄をクリアする。
- **デバッグポイント:**
    - チャートがセッション開始前の状態に完全に戻るか。
    - UIが初期状態にリセットされるか。

## #9: データ保存の文字化け修正
- **内容:**
    - `[セッションを完了して記録]` を押した際に、CSVファイルに保存される日本語コメントが文字化けする（"□"になる）問題を修正する。
    - `FileOpen`時に`FILE_UNICODE`フラグを追加し、ファイルをUnicode (UTF-16 LE)形式で保存するように変更する。
- **デバッグポイント:**
    - 日本語を含むコメントを入力し、保存された`trades.csv`および`evidence.csv`をテキストエディタやExcelで開いた際に、文字化けせずに正しく表示されるか。

## #10: 全体的なリファクタリング
- **内容:**
    - `ChartMemo.mq4`のコードベースが大きくなってきたため、可読性とメンテナンス性を向上させるためのリファクタリングを行う。
    - 巨大な関数（特に`OnInit`, `SaveCsvFiles`）を、より小さく、目的が明確なヘルパー関数に分割する。
    - グローバル変数の使用を見直し、適切なスコープに限定する。
    - コード全体のスタイルや命名規則を統一する。
- **デバッグポイント:**
    - リファクタリング後も、既存のすべての機能（UI操作、描画、保存、クリーンアップ）が以前と同様に正しく動作するか。
