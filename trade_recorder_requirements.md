# 要件定義書：裁量トレード記録・分析ツール

## 1. 概要
MetaTrader 4 (MT4) 上で、裁量によるトレード判断の根拠を視覚的・言語的に記録し、将来的なEA(Expert Advisor)開発のための分析用データを蓄積するインジケーターを開発する。

## 2. 目的
- 裁量トレードの判断プロセスを客観的なデータとして保存する。
- 保存したデータを分析し、トレードルールの言語化・数値化を促進する。
- EA開発に必要なロジックの土台となる、質の高い情報資産を構築する。

## 3. 主要機能
### 3.1. 記録セッション機能
- 複数の時間足チャートを横断して、一連のトレード判断（根拠収集からエントリー判断まで）を「1セッション」として管理する。

### 3.2. 根拠エリア記録機能
- トレード判断の根拠となるチャート上の範囲を、色付きのオブジェクトで複数指定できる。
- **形状:** 青色の四角形。
- **番号付け:** 描画した順に「1, 2, 3...」と番号が自動で付与される。
- **手動オブジェクト:** トレンドラインなどを手動で描画することも可能。これらは画像には記録されるが、座標データは保存対象外とする。

### 3.3. トレードエリア記録機能
- 実際にエントリー・イグジットを検討する範囲を、色付きのオブジェクトで指定できる。
- **形状:** 赤色の四角形。
- 1セッションにつき1つ指定する。

### 3.4. コメント機能
- **根拠コメント:** 番号付けされた各根拠エリアに対応する、個別の解説を記述する。
- **全体コメント:** セッション全体を俯瞰した、総合的なトレードシナリオや判断理由を記述する。

### 3.5. データ保存機能
- 1回の記録セッション完了時に、以下の3つの情報を一括で保存する。
    1. **チャート画像:** 描画した全てのオブジェクトが含まれた状態のスクリーンショット。
    2. **トレードデータ (trades.csv):** セッション全体の情報を記録する。
    3. **根拠データ (evidence.csv):** 個別の根拠情報を記録する。

## 4. 操作フロー
1. ユーザーがチャート上の `[記録セッション開始]` ボタンを押す。
2. ユーザーは週足、日足、4時間足など、複数のチャートを自由に移動する。
3. 各チャートで `[根拠エリア追加]` ボタンを押し、マウスドラッグで根拠となる範囲を青い四角形で描画する。描画されたエリアには自動で番号が付与される。
4. UIパネルに、描画された根拠に対応するコメント入力欄（例: 「根拠1: [ ]」）が動的に追加される。ユーザーは随時、各根拠の解説を記入する。
5. ユーザーはステップ3と4を繰り返す。
6. ユーザーは必要に応じて、手動でトレンドラインなどを描画する。
7. エントリーを検討するメインのチャートで `[トレードエリア追加]` ボタンを押し、赤い四角形を描画する。
8. UI上の「全体コメント」欄に、総合的な判断を記入する。
9. `[セッションを完了して記録]` ボタンを押す。
10. 内部処理が実行され、データと画像が保存される。
11. 保存完了後、セッション中に描画された全てのオブジェクト（四角形、番号）がチャート上から自動で削除され、UIのコメント欄もクリアされる。

## 5. UI仕様
- チャートの隅に、以下の要素を持つパネルを常時表示する。
    - `[記録セッション開始]` ボタン
    - `[根拠エリア追加]` ボタン
    - `[トレードエリア追加]` ボタン
    - `[セッションを完了して記録]` ボタン
    - **根拠コメントエリア:** `[根拠エリア追加]` を行うたびに、個別のコメント入力欄（例: 「根拠1: [テキストボックス]」）が動的に追加されていく領域。
    - 「全体コメント」用の大型テキスト入力ボックス

## 6. データ構造
- **保存先フォルダ:** `(MT4データフォルダ)\MQL4\Files\ChartMemo\`
- **ファイル構成:** 
    1. **`trades.csv`**
        - `TradeID`: 記録セッション全体でユニークなID（例: タイムスタンプ）。
        - `Timestamp`: 記録日時。
        - `Symbol`: 通貨ペア。
        - `Timeframe`: トレードエリアを描画したチャートの時間足。
        - `GlobalComment`: 全体コメント。
        - `ScreenshotFile`: 保存された画像ファイル名。
        - `TradeArea_StartTime`, `TradeArea_StartPrice`, `TradeArea_EndTime`, `TradeArea_EndPrice`: 赤い四角形の四隅の座標。
    2. **`evidence.csv`**
        - `EvidenceID`: 各根拠データでユニークなID。
        - `TradeID`: `trades.csv` と紐づけるためのID。
        - `EvidenceNumber`: 描画された根拠の番号（1, 2, 3...）。
        - `EvidenceTimeframe`: その根拠を描画したチャートの時間足。
        - `EvidenceComment`: 個別の根拠コメント。
        - `EvidenceArea_StartTime`, `EvidenceArea_StartPrice`, `EvidenceArea_EndTime`, `EvidenceArea_EndPrice`: 青い四角形の四隅の座標。
    3. **画像ファイル (*.png)**
        - ファイル名: `(通貨ペア)_(時間足)_(TradeID).png` （例: `EURUSD_H1_1662811800.png`）

## 7. 対象外・将来の課題
- **自動トレンドライン描画機能:** 手動で描画したトレンドラインの形状を自動で認識・再現する機能は本プロジェクトの対象外とする。将来的に、蓄積されたデータを元にアルゴリズムを開発する際の課題とする。